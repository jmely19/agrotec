<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AGROTEC - Farmer Dashboard. Manage your products, profile and sales.">
    <meta name="author" content="AGROTEC">
    
    <!-- SEO Meta Tags -->
    <title>AGROTEC - Farmer Dashboard</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/perfil.css">
</head>
<body>
    <!-- Session verification loader -->
    <div id="sessionLoader" class="session-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Verifying session...</div>
    </div>

    <!-- Header/Navigation with farmer profile -->
    <header class="header" role="banner">
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="container">
                <!-- Logo -->
                <div class="navbar__brand">
                    <a href="farmerindex.html" class="navbar__logo" aria-label="AGROTEC Farmer Home">
                        <img src="img/logo.png" alt="AGROTEC Logo" class="navbar__logo-img">
                    </a>
                </div>
                
                <!-- Navigation Menu for Farmers -->
                <ul class="navbar__menu" role="menubar">
                    <li class="navbar__item" role="none">
                        <a href="#" onclick="showSection('Home')" class="navbar__link" role="menuitem">HOME</a>
                    </li>
                    <li class="navbar__item" role="none">
                        <a href="#" onclick="showSection('Products)" class="navbar__link" role="menuitem">PRODUCTS</a>
                    </li>
                    <li class="navbar__item" role="none">
                        <a href="#" onclick="showSection('orders')" class="navbar__link" role="menuitem">ORDERS</a>
                    </li>
                    <li class="navbar__item" role="none">
                        <a href="#" onclick="showSection('profile')" class="navbar__link" role="menuitem">PROFILE</a>
                    </li>
                </ul>
                
                <!-- Farmer Profile in Header -->
                <div class="navbar__actions">
                    <div class="farmer-navbar-profile" onclick="showSection('profile')">
                        <img src="img/home/profile.webp" alt="Profile" id="farmerNavbarImage">
                        <div class="farmer-navbar-info">
                            <span id="farmerNavbarName" class="farmer-navbar-name">Loading...</span>
                            <span class="farmer-navbar-type">Farmer</span>
                        </div>
                    </div>
                    
                    <span class="navbar__divider">|</span>
                    
                    <a href="#" onclick="logout()" class="navbar__logout">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" x2="9" y1="12" y2="12"></line>
                        </svg>
                        <span class="navbar__logout-text">Logout</span>
                    </a>
                </div>
                
                <!-- Mobile Menu Toggle -->
                <button class="navbar__toggle" aria-label="Toggle mobile menu" aria-expanded="false">
                    <span class="navbar__toggle-line"></span>
                    <span class="navbar__toggle-line"></span>
                    <span class="navbar__toggle-line"></span>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Layout -->
    <div class="main-layout" id="mainLayout">
        <!-- Combined Sidebar -->
        <div class="combined-sidebar" id="sidebar">
            <!-- Profile Section -->
            <div class="profile-section">
                <img id="profilePic" src="img/home/profile.webp" alt="Profile" class="profile-pic">
                <input type="file" id="uploadInput" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('uploadInput').click()">
                    <i class="fas fa-camera"></i> Change Photo
                </button>
                <div class="farmer-name" id="sidebarFarmerName">Farmer Name</div>
                <div class="farmer-type">Certified Farmer</div>
            </div>
            
            <!-- Navigation -->
            <ul class="navigation-menu">
                <li><a onclick="showSection('dashboard')" id="nav-dashboard" class="active">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a></li>
                <li><a onclick="showSection('profile')" id="nav-profile">
                    <i class="fas fa-user"></i> My Profile
                </a></li>
                <li><a onclick="showSection('products')" id="nav-products">
                    <i class="fas fa-box"></i> Products
                </a></li>
                <li><a onclick="showSection('orders')" id="nav-orders">
                    <i class="fas fa-chart-line"></i> Sales
                </a></li>
                <li><a onclick="showSection('customers')" id="nav-customers">
                    <i class="fas fa-users"></i> Customers
                </a></li>
                <li><a onclick="showSection('reports')" id="nav-reports">
                    <i class="fas fa-chart-bar"></i> Reports
                </a></li>
                <li><a onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- SECTION: DASHBOARD -->
            <div id="dashboard" class="content-section active">
                <!-- Welcome Section -->
                <div class="welcome-section">
                    <h1>Welcome, <span id="farmerWelcomeName">Farmer</span>!</h1>
                    <p><span id="farmerBusinessName">Your Business</span> - <span id="farmerLocation">Location</span></p>
                    
                    <div class="farmer-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="totalProducts">0</span>
                            <span>Products</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalSales">$0</span>
                            <span>Monthly Sales</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="pendingOrders">0</span>
                            <span>Pending Orders</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="customerReviews">0</span>
                            <span>Reviews</span>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Cards -->
                <div class="dashboard-cards">
                    <div class="dashboard-card" onclick="showSection('products')">
                        <h3>
                            <i class="fas fa-box"></i>
                            My Products
                        </h3>
                        <p>Manage your inventory, add new products, update prices and control available stock.</p>
                        <button class="card-action">Manage Products</button>
                    </div>
                    
                    <div class="dashboard-card" onclick="showSection('orders')">
                        <h3>
                            <i class="fas fa-chart-line"></i>
                            Sales Dashboard
                        </h3>
                        <p>Review your sales, analyze trends and get detailed reports of your commercial performance.</p>
                        <button class="card-action">View Sales</button>
                    </div>
                    
                    <div class="dashboard-card" onclick="showSection('customers')">
                        <h3>
                            <i class="fas fa-users"></i>
                            My Customers
                        </h3>
                        <p>Manage your customer base, review purchase history and improve business relationships.</p>
                        <button class="card-action">View Customers</button>
                    </div>
                    
                    <div class="dashboard-card" onclick="showSection('reports')">
                        <h3>
                            <i class="fas fa-chart-bar"></i>
                            Reports
                        </h3>
                        <p>Analyze your business performance with detailed reports and growth metrics.</p>
                        <button class="card-action">View Reports</button>
                    </div>
                </div>
            </div>

            <!-- SECTION: PROFILE -->
            <div id="profile" class="content-section">
                <div class="profile-details">
                    <h2><i class="fas fa-user-edit"></i> Profile Details</h2>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-user"></i> First Name:</label>
                        <input id="name" type="text" placeholder="Your first name">
                    </div>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-user"></i> Last Name:</label>
                        <input id="lastName" type="text" placeholder="Your last name">
                    </div>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-envelope"></i> Email:</label>
                        <input id="email" type="email" placeholder="Your email" readonly class="readonly-field">
                    </div>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-store"></i> Business:</label>
                        <input id="business" type="text" placeholder="Your business name">
                    </div>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-phone"></i> Phone:</label>
                        <input id="phone" type="text" placeholder="Business phone number">
                    </div>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-map-marker-alt"></i> Location:</label>
                        <input id="location" type="text" placeholder="Your business location">
                    </div>
                    
                    <div class="detail-item">
                        <label><i class="fas fa-home"></i> Address:</label>
                        <input id="address" type="text" placeholder="Complete address">
                    </div>
                    
                    <button class="modify-btn" onclick="saveDetails()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>

            <!-- SECTION: PRODUCTS -->
            <div id="products" class="content-section">
                <div class="products-section">
                    <div id="screen1" class="card">
                        <h2><i class="fas fa-plus-circle"></i> Add products</h2>
                        <p>Start by adding products that your customers will love.</p>
                        <div class="actions-row">
                            <button class="btn btn-black" onclick="showForm()">
                                <i class="fas fa-plus"></i> Add product
                            </button>
                            <button class="btn btn-outline" onclick="alert('Feature in development')">
                                <i class="fas fa-upload"></i> Import
                            </button>
                        </div>
                    </div>

                    <div id="screen2" class="card" style="display:none;">
                        <div class="header-row">
                            <h2><i class="fas fa-plus"></i> Add products</h2>
                            <div class="status-group">
                                <label class="chip">
                                    <input type="checkbox" id="statusOnline" checked />
                                    <span><i class="fas fa-globe"></i> Online Store</span>
                                </label>
                                <label class="chip">
                                    <input type="checkbox" id="statusPOS" />
                                    <span><i class="fas fa-cash-register"></i> Point of Sale</span>
                                </label>
                            </div>
                        </div>

                        <form id="productForm" autocomplete="off">
                            <label class="field">
                                <span class="label"><i class="fas fa-tag"></i> Title</span>
                                <input type="text" name="title" placeholder="One pound of onions" required />
                            </label>

                            <label class="field">
                                <span class="label"><i class="fas fa-align-left"></i> Description</span>
                                <textarea name="description" rows="3" placeholder="Describe your product..."></textarea>
                            </label>

                            <div class="field">
                                <span class="label"><i class="fas fa-image"></i> Media</span>
                                <div class="upload-row">
                                    <label class="btn btn-light">
                                        <input id="imageInput" type="file" accept="image/*" hidden />
                                        <i class="fas fa-upload"></i> Upload image
                                    </label>
                                    <button type="button" class="btn btn-outline" id="removeImageBtn" disabled>
                                        <i class="fas fa-trash"></i> Remove image
                                    </button>
                                </div>
                                <div id="preview" class="preview" style="display:none;">
                                    <img id="previewImg" alt="Preview" />
                                    <div class="preview-meta"><span id="previewName"></span></div>
                                </div>
                            </div>

                            <label class="field">
                                <span class="label"><i class="fas fa-dollar-sign"></i> Price</span>
                                <input type="number" name="price" step="0.01" min="0" placeholder="0.00" />
                            </label>

                            <div class="field">
                                <span class="label"><i class="fas fa-weight-hanging"></i> Weight</span>
                                <div class="weight-row">
                                    <input id="weightValue" type="number" step="0.01" min="0" placeholder="0.00" />
                                    <select id="weightUnit">
                                        <option value="kg">kg</option>
                                        <option value="lb">lb</option>
                                    </select>
                                </div>
                                <div id="weightHint" class="hint"></div>
                            </div>

                            <div class="actions-row">
                                <button type="submit" class="btn btn-black">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button type="button" class="btn btn-outline" onclick="cancelForm()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="screen3" class="card" style="display:none;">
                        <div class="header-row">
                            <h2><i class="fas fa-boxes"></i> Products</h2>
                            <div class="actions-row">
                                <button class="btn btn-outline" onclick="exportCSV()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                                <button class="btn btn-outline" onclick="alert('Feature in development')">
                                    <i class="fas fa-upload"></i> Import
                                </button>
                                <button class="btn btn-black" onclick="showForm()">
                                    <i class="fas fa-plus"></i> Add product
                                </button>
                            </div>
                        </div>
                        <div class="search-box">
                            <input id="searchInput" type="text" placeholder="ðŸ” Search products..." oninput="renderTable()" />
                        </div>
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Status</th>
                                    <th>Category</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <tr>
                                    <td colspan="3" class="empty-state">
                                        <i class="fas fa-box-open empty-state-icon"></i>
                                        Loading products...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: ORDERS/SALES -->
            <div id="orders" class="content-section">
                <div class="profile-details">
                    <h2><i class="fas fa-chart-line"></i> Sales History</h2>
                    <ul id="ordersList">
                        <li class="empty-state">
                            <i class="fas fa-shopping-cart empty-state-icon"></i>
                            Loading history...
                        </li>
                    </ul>
                </div>
            </div>

            <!-- SECTION: CUSTOMERS -->
            <div id="customers" class="content-section">
                <div class="profile-details">
                    <h2><i class="fas fa-users"></i> My Customers</h2>
                    <div class="coming-soon">
                        <i class="fas fa-users coming-soon-icon"></i>
                        <h3>Customers Module</h3>
                        <p>This functionality will be available soon.</p>
                        <button class="modify-btn" onclick="showSection('dashboard')">
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- SECTION: REPORTS -->
            <div id="reports" class="content-section">
                <div class="profile-details">
                    <h2><i class="fas fa-chart-bar"></i> Reports and Analytics</h2>
                    <div class="coming-soon">
                        <i class="fas fa-chart-bar coming-soon-icon"></i>
                        <h3>Reports Module</h3>
                        <p>This functionality will be available soon.</p>
                        <button class="modify-btn" onclick="showSection('dashboard')">
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global variables
        let currentFarmer = null;
        let currentSection = 'dashboard';
        
        // Immediate session verification
        (function() {
            const userSession = sessionStorage.getItem('agrotec_user');
            const loginTime = sessionStorage.getItem('agrotec_login_time');
            
            if (!userSession || !loginTime) {
                alert('You must log in to access the dashboard');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const user = JSON.parse(userSession);
                const loginDate = new Date(loginTime);
                const now = new Date();
                const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
                
                if (hoursDiff >= 24) {
                    sessionStorage.removeItem('agrotec_user');
                    sessionStorage.removeItem('agrotec_login_time');
                    alert('Your session has expired. Please log in again.');
                    window.location.href = 'login.html';
                    return;
                }
                
                if (user.type !== 'FARMER') {
                    alert('This page is for farmers only.');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentFarmer = user;
                
                // Hide loader and show content
                setTimeout(() => {
                    document.getElementById('sessionLoader').classList.add('hidden');
                    document.getElementById('mainLayout').style.display = 'flex';
                    initializeFarmerDashboard();
                }, 1000);
                
            } catch (error) {
                console.error('Error verifying session:', error);
                alert('Session error. Please log in again.');
                window.location.href = 'login.html';
            }
        })();
        
        // Main initialization
        function initializeFarmerDashboard() {
            console.log('Initializing combined dashboard...');
            loadFarmerData();
            loadFarmerStats();
            showNotification(`Welcome, ${currentFarmer.name}!`, 'success');
        }
        
        // Load farmer data
        function loadFarmerData() {
            const farmerName = `${currentFarmer.name} ${currentFarmer.lastName}`;
            
            // Update elements throughout the interface
            document.getElementById('farmerWelcomeName').textContent = currentFarmer.name;
            document.getElementById('farmerNavbarName').textContent = farmerName;
            document.getElementById('sidebarFarmerName').textContent = farmerName;
            
            // Farmer specific information
            const businessName = currentFarmer.businessName || currentFarmer.business || 'Your Business';
            const location = currentFarmer.location || 'Location not specified';
            
            document.getElementById('farmerBusinessName').textContent = businessName;
            document.getElementById('farmerLocation').textContent = location;
            
            // Load data into profile form
            document.getElementById('name').value = currentFarmer.name || '';
            document.getElementById('lastName').value = currentFarmer.lastName || '';
            document.getElementById('email').value = currentFarmer.email || '';
            document.getElementById('business').value = businessName;
            document.getElementById('phone').value = currentFarmer.phone || '';
            document.getElementById('location').value = location;
            
            // Update images if available
            if (currentFarmer.profileImage) {
                document.getElementById('farmerNavbarImage').src = currentFarmer.profileImage;
                document.getElementById('profilePic').src = currentFarmer.profileImage;
            }
            
            console.log('Farmer data loaded throughout interface');
        }
        
        // Load statistics (simulated for now)
        function loadFarmerStats() {
            const stats = {
                totalProducts: Math.floor(Math.random() * 25) + 5,
                totalSales: Math.floor(Math.random() * 5000) + 1000,
                pendingOrders: Math.floor(Math.random() * 15) + 1,
                customerReviews: Math.floor(Math.random() * 50) + 10
            };
            
            document.getElementById('totalProducts').textContent = stats.totalProducts;
            document.getElementById('totalSales').textContent = `${stats.totalSales.toLocaleString()}`;
            document.getElementById('pendingOrders').textContent = stats.pendingOrders;
            document.getElementById('customerReviews').textContent = stats.customerReviews;
        }
        
        // Main function to change sections
        function showSection(sectionName) {
            console.log(`Changing to section: ${sectionName}`);
            
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Show selected section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update active navigation
            const navItems = document.querySelectorAll('.navigation-menu a');
            navItems.forEach(item => item.classList.remove('active'));
            
            const activeNavItem = document.getElementById(`nav-${sectionName}`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
            
            // Update navbar if exists
            const navbarLinks = document.querySelectorAll('.navbar__link');
            navbarLinks.forEach(link => link.classList.remove('navbar__link--active'));
            
            currentSection = sectionName;
            
            // Section-specific actions
            switch(sectionName) {
                case 'products':
                    // Initialize products if necessary
                    console.log('Loading products module...');
                    break;
                case 'profile':
                    console.log('Loading farmer profile...');
                    break;
                case 'dashboard':
                    loadFarmerStats(); // Refresh statistics
                    break;
            }
        }
        
        // Function to save profile details
        function saveDetails() {
            const updatedData = {
                name: document.getElementById('name').value,
                lastName: document.getElementById('lastName').value,
                business: document.getElementById('business').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                address: document.getElementById('address').value
            };
            
            console.log('Saving profile data:', updatedData);
            
            // Update current farmer data
            currentFarmer.name = updatedData.name;
            currentFarmer.lastName = updatedData.lastName;
            currentFarmer.businessName = updatedData.business;
            currentFarmer.phone = updatedData.phone;
            currentFarmer.location = updatedData.location;
            
            // Update in sessionStorage
            sessionStorage.setItem('agrotec_user', JSON.stringify(currentFarmer));
            
            // TODO: This would connect to database to save permanently
            // const result = window.updateFarmerProfile(currentFarmer.id, updatedData);
            
            showNotification('Profile updated successfully', 'success');
            
            // Refresh data in interface
            loadFarmerData();
        }
        
        // Product functions
        function showForm() {
            console.log('Showing product form...');
            document.getElementById('screen1').style.display = 'none';
            document.getElementById('screen2').style.display = 'block';
            document.getElementById('screen3').style.display = 'none';
        }
        
        function cancelForm() {
            console.log('Canceling product form...');
            document.getElementById('screen1').style.display = 'block';
            document.getElementById('screen2').style.display = 'none';
            document.getElementById('screen3').style.display = 'none';
            // Reset form
            document.getElementById('productForm').reset();
            document.getElementById('preview').style.display = 'none';
            document.getElementById('removeImageBtn').disabled = true;
        }
        
        function showProductsList() {
            console.log('Showing products list...');
            document.getElementById('screen1').style.display = 'none';
            document.getElementById('screen2').style.display = 'none';
            document.getElementById('screen3').style.display = 'block';
            renderTable();
        }
        
        // Handle product form submission
        document.addEventListener('DOMContentLoaded', function() {
            const productForm = document.getElementById('productForm');
            const imageInput = document.getElementById('imageInput');
            const preview = document.getElementById('preview');
            const previewImg = document.getElementById('previewImg');
            const previewName = document.getElementById('previewName');
            const removeImageBtn = document.getElementById('removeImageBtn');
            
            if (productForm) {
                productForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Submitting product form...');
                    
                    const formData = new FormData(productForm);
                    const productData = {
                        title: formData.get('title'),
                        description: formData.get('description'),
                        price: formData.get('price'),
                        weight: document.getElementById('weightValue').value,
                        weightUnit: document.getElementById('weightUnit').value,
                        statusOnline: document.getElementById('statusOnline').checked,
                        statusPOS: document.getElementById('statusPOS').checked,
                        image: previewImg.src || null
                    };
                    
                    console.log('Product data:', productData);
                    
                    // TODO: Save to database
                    showNotification('Product added successfully!', 'success');
                    
                    // Show products list
                    showProductsList();
                });
            }
            
            // Handle image upload
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        console.log('Image selected:', file.name);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            previewName.textContent = file.name;
                            preview.style.display = 'flex';
                            removeImageBtn.disabled = false;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Handle remove image
            if (removeImageBtn) {
                removeImageBtn.addEventListener('click', function() {
                    console.log('Removing image...');
                    imageInput.value = '';
                    preview.style.display = 'none';
                    removeImageBtn.disabled = true;
                });
            }
        });
        
        function exportCSV() {
            alert('Export CSV function in development');
        }
        
        function renderTable() {
            console.log('Rendering products table...');
        }
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                console.log('Logging out...');
                sessionStorage.removeItem('agrotec_user');
                sessionStorage.removeItem('agrotec_login_time');
                window.location.href = 'login.html';
            }
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification notification-' + type;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('notification-exit');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // Periodic session verification
        setInterval(() => {
            const userSession = sessionStorage.getItem('agrotec_user');
            const loginTime = sessionStorage.getItem('agrotec_login_time');
            
            if (!userSession || !loginTime) {
                showNotification('Your session has expired. You will be redirected to login.', 'error');
                setTimeout(() => window.location.href = 'login.html', 3000);
                return;
            }
            
            try {
                const loginDate = new Date(loginTime);
                const now = new Date();
                const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
                
                if (hoursDiff >= 24) {
                    sessionStorage.removeItem('agrotec_user');
                    sessionStorage.removeItem('agrotec_login_time');
                    showNotification('Your session has expired. You will be redirected to login.', 'error');
                    setTimeout(() => window.location.href = 'login.html', 3000);
                }
            } catch (error) {
                console.error('Error verifying session:', error);
            }
        }, 300000); // Check every 5 minutes
        
        // Debug functions
        window.farmerDashboardDebug = {
            getCurrentFarmer: () => currentFarmer,
            getCurrentSection: () => currentSection,
            refreshStats: loadFarmerStats,
            testNotification: () => showNotification('Test notification', 'success'),
            showSection: showSection
        };
        
        // Profile photo change handling
        document.getElementById('uploadInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    document.getElementById('profilePic').src = imageUrl;
                    document.getElementById('farmerNavbarImage').src = imageUrl;
                    
                    // TODO: This would upload image to server
                    showNotification('Profile photo updated', 'success');
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
    
    <!-- Main scripts (replaces existing ones) -->
    <script src="js/database-simulator.js"></script>
    <script src="js/minimal-universal-session.js"></script> 
    <script src="js/profile-photo-system.js"></script>
    <script src="js/cart-shared.js"></script>
    <script src="js/farmer-product-integration.js"></script>
    <script src="js/home.js"></script>
</body>

</html>
